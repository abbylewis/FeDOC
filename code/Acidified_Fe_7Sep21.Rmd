---
title: "R Notebook"
output: html_notebook
---

```{r}
library(readxl)
library(tidyverse)

sep02 <- read.csv("../data/clean_data/exp_water_02Sep21.csv")%>%
  mutate(Day = as.Date("2021-09-02"))
sep07 <- read.csv("../data/clean_data/exp_water_07Sep21.csv")%>%
  mutate(Day = as.Date("2021-09-07"))
sep08 <- read.csv("../data/clean_data/exp_water_08Sep21.csv")%>%
  mutate(Day = as.Date("2021-09-08"))
sep09 <- read.csv("../data/clean_data/exp_water_09Sep21.csv")%>%
  mutate(Day = as.Date("2021-09-09"))
aug31 <- read.csv("../data/clean_data/exp_water_31Aug21.csv")%>%
  mutate(Day = as.Date("2021-08-31"))

full = sep02%>%
  full_join(sep07)%>%
  full_join(sep08)%>%
  full_join(sep09)%>%
  full_join(aug31)%>%
  select(-Comments,-Type)%>%
  filter(!grepl("spk|dup",Sample.ID))

full[full$Sample.ID=="aor2d6s",]

full$Type = "Unknown"
full$Type[grepl("std", full$Sample.ID)]<-"Standard"
full$Conc[grepl("std", full$Sample.ID)] = as.numeric(sub("std","",full$Sample.ID[grepl("std", full$Sample.ID)]))
full$Treatment[!grepl("std", full$Sample.ID)] <- substr(full$Sample.ID[!grepl("std", full$Sample.ID)],1,2)
full$Sample_day[!grepl("std", full$Sample.ID)] <- as.numeric(sub("[a-z]+[0-9]+d","",sub("([a-z](_.+)*$)","",full$Sample.ID[!grepl("std", full$Sample.ID)])))
full$Rep[!grepl("std", full$Sample.ID)] <- as.numeric(substr(full$Sample.ID[!grepl("std", full$Sample.ID)],4,4))
full$filt[!grepl("std", full$Sample.ID)] <- sub("[a-z]+[0-9]+[a-z]+[0-9]+","",sub("_.+","",full$Sample.ID[!grepl("std", full$Sample.ID)]))
full$Dilution[is.na(full$Dilution)]<-0
full_conc = full%>%
  filter(Type!="Standard",
         !duplicated(Sample.ID))%>%
  filter(Sample_day != 0)%>%
  select(-Sample.ID, -Conc)

for(day in unique(full$Day)){
  if(day == as.Date("2021-09-07")){
    r = full%>%
      filter(Day == day)
  }else{
    r = full%>%
      filter(Day == day,
             Conc != 1185.8)
  }
  coef = lm(r$Conc~0+r$WL562)
  sum = summary(coef)
  print(paste0(day," r: adjusted r2 = ",sum$adj.r.squared))
  
  full_conc$Conc <- coef$coefficients*full_conc$WL562
}

full_conc$Conc[!is.na(full_conc$Dilution)&full_conc$Dilution>0] = full_conc$Conc[!is.na(full_conc$Dilution)&full_conc$Dilution>0] *1/full_conc$Dilution[!is.na(full_conc$Dilution)&full_conc$Dilution>0]

full_conc$Treatment[full_conc$Treatment=="aa"]<-"Anoxic"
full_conc$Treatment[full_conc$Treatment=="oo"]<-"Oxic"
full_conc$Treatment[full_conc$Treatment=="oa"]<-"Oxic to anoxic"
full_conc$Treatment[full_conc$Treatment=="ao"]<-"Anoxic to oxic"

fer = full_conc
fer$filt[fer$filt=="s"]<-"Filtered"
fer$filt[fer$filt=="t"]<-"Unfiltered"

fer$Status <- "Oxic"
fer$Status[fer$Treatment %in%c("Anoxic to oxic","Anoxic")]<- "Anoxic"

write.csv(fer,"../data/processed_data/acidified_Fe_formatted.csv", row.names = F)

full_conc$Treatment[full_conc$Treatment=="Anoxic to oxic"&full_conc$Sample_day<=13]<-"Anoxic"
full_conc$Treatment[full_conc$Treatment=="Oxic to anoxic"&full_conc$Sample_day<=13]<-"Oxic"

f = fer%>%
  filter(!is.na(Treatment))%>%
  ggplot(aes(x = Sample_day, y = Conc/1000, color = Treatment, shape = as.factor(Rep)))+
  geom_point()+
  ylab("Fe (mg/L)")+
  geom_vline(xintercept = 13.5)+
  scale_color_manual(values = c("#175676","#D58936","#A44200","#4BA3C3")) +
  facet_grid(Status~filt)+
  theme_bw()

f

library(plotly)
ggplotly(f)

fer%>%
  filter(Treatment == "Oxic to anoxic",
         Sample_day == 34)

full%>%
  filter(Treatment == "ao",filt == "t", Sample_day == 23)%>%
  arrange(Rep)

## A couple samples were analyzed on both the 9th and the 7th: oar2d9t
## missing: aar2d6s
## oor1s could be oor1d16s

```

