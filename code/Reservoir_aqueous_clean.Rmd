---
title: "Reservoir aqueous samples"
author: "Abby Lewis"
date: "11/25/2020"
output: html_document
---

This code file plots dissolved oxygen, iron, and disolved organic carbon from the water column of Falling Creek and Beaverdam reservoirs (figures 5 and 6 of the manuscript). It is necessary to run all code chunks in order.
Section 0: Load packages
Section 1: Load oxygen (CTD and YSI) data
Section 2: Calculate volume-weighted hypolimnetic dissolved oxygen means
Section 3: Interpolate dissolved oxygen and graph (figure 6)
Section 4: Load DOC and iron data
Section 5: Graph Fe, DOC, and oxygen (Figure 5)


Section 0: Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(akima)
library(colorRamps)
library(lubridate)
library(ggpubr)
library(rLakeAnalyzer)
```



Section 1: Load oxygen (CTD and YSI) data
This section loads oxygen data and creates a dataset that combines CTD and YSI measurements from Falling Creek and Beaverdam Reservoirs. Data inputs for this section include oxygen measurements from two sensors (CTD and YSI). No outputs are produced.
```{r}
#Load CTD data
do <- read.csv('../data/clean_data/CTD_2013_2021.csv')
#Format data and select data from only the deepest point in the reservoir
do = do%>%
  mutate(Date = as.Date(Date))%>%
  filter(!is.na(DO_mgL),
         Site == 50,
         year(Date)!=2021|
           (Date>=as.Date("2021-03-01")&Date<as.Date("2021-07-01")), #Due to issues with the oxygen sensor in 2021, we are removing data outside of this interval
         Date != as.Date("2019-07-18")|Reservoir=="FCR") #Removing one cast from BVR in 2018

#Decrease dataset size by triming to 0.1m depth intervals
depths <- seq(0,11, by = .1)
newDepths <- depths
df.final<- do %>% group_by(Date, Reservoir) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[1]))) #Create a new dataframe
df.final$Depth_m <- newDepths[1]
for (i in 2:length(depths)){ #loop through all depths and add the closest values to the final dataframe
  ctd_atThisDepth <- do %>% group_by(Date, Reservoir) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[i])))
  ctd_atThisDepth = ctd_atThisDepth%>%
    filter(abs(Depth_m-newDepths[i])<0.1) #only include if the measured depth is within 0.1 of the depth we are labeling it
  ctd_atThisDepth$Depth_m <- newDepths[i]
  df.final <- rbind(df.final,ctd_atThisDepth)
}




#Load YSI data from EDI
inUrl2  <- "https://pasta.lternet.edu/package/data/eml/edi/198/9/b3bd353312f9e37ca392e2a5315cc9da" 
infile2 <- tempfile()
try(download.file(inUrl2,infile2,method="curl"))
if (is.na(file.size(infile2))) download.file(inUrl2,infile2,method="auto")
 ysi <-read.csv(infile2,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "Reservoir",     
                    "Site",     
                    "DateTime",     
                    "Depth_m",     
                    "Temp_C",     
                    "DO_mgL",     
                    "DOSat",     
                    "Cond_uScm",     
                    "Sp_cond_uScm",     
                    "PAR_umolm2s",     
                    "ORP_mV",     
                    "pH",     
                    "Flag_DateTime",     
                    "Flag_Temp",     
                    "Flag_DO",     
                    "Flag_DOSat",     
                    "Flag_Cond",     
                    "Flag_Sp_Cond",     
                    "Flag_PAR",     
                    "Flag_ORP",     
                    "Flag_pH"    ), check.names=TRUE)
               
unlink(infile2)

#Format YSI data
ysi_formatted = ysi%>%
  filter(!is.na(DO_mgL),
         Site == 50)%>% #Only the deepest site
  mutate(Date = as.Date(DateTime))%>%
  select("Reservoir",
         "Site",
         "Date",
         "Depth_m",
         "DO_mgL",
         "Temp_C")%>%
  #We are only using YSI to fill in gaps in CTD data. Select data for those gaps here
  filter((Date>=as.Date("2021-07-01")&Date<as.Date("2021-12-01"))|
           (Date>=as.Date("2019-03-01")&Date<as.Date("2019-06-01"))|
           (Date>=as.Date("2017-05-01")&Date<as.Date("2017-11-01"))|
           (Date>=as.Date("2020-03-01")&Date<as.Date("2020-06-18")))%>%
  mutate(method = "ysi")





# Combine CTD and YSI data
df.final.new = df.final%>%
  full_join(ysi_formatted)
```



Section 2: Calculate volume-weighted means
This section calculates volume-weighted hypolimnetic oxygen concentrations in falling creek and beaverdam reservoirs. Inputs to this section are the dataframe created in section 1, as well as bathymetry from both reservoirs. No outputs are produced.
```{r}
### FCR
vol_fcr <- read_csv("../data/processed_data/FCR Bathymetry.csv")
colnames(vol_fcr) <- c("Depth_m","Volume_L","SA_m2")
depths <- vol_fcr$Depth_m

dt1_culled = df.final.new %>% filter(Reservoir == "FCR") %>%arrange(Date)
df.final2<-dt1_culled %>% group_by(Date) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[1]))) #Create a new dataframe
df.final2$Depth_m <- depths[1]
for (j in 2:length(depths)){ #loop through all depths and add the closest values to the final dataframe
  ctd_atThisDepth <- dt1_culled %>% group_by(Date) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[j])))
  ctd_atThisDepth$Depth_m <- depths[j]
  df.final2 <- rbind(df.final2,ctd_atThisDepth)
}
df.final2_fcr = df.final2

df.final2_fcr%>%
  filter(!is.na(method))

thermo_fcr <- df.final2_fcr %>%
  filter(!is.na(Temp_C))%>%
  group_by(Date) %>%
  summarize(meta_bottom = meta.depths(Temp_C, Depth_m)[2])

vw_fcr <- df.final2_fcr %>%
  #filter(as.Date(Date)!=as.Date("2017-07-06")) %>%
  group_by(Date) %>%
  left_join(thermo_fcr, by = "Date") %>%
  mutate(Thermocline = meta_bottom) %>% 
  ungroup() %>%
  left_join(vol_fcr, by = "Depth_m")%>%
  mutate(DO_Weighted = DO_mgL*Volume_L,
         TP_Weighted = Temp_C*Volume_L) %>%
  filter(Depth_m >= Thermocline,) %>%
  group_by(Date) %>%
  summarize(
    Reservoir = "FCR",
    thermo_depth = unique(Thermocline),
    Vol_Weighted_DO = sum(DO_Weighted),
    hypoVolume = sum(Volume_L),
    DO_mgL = Vol_Weighted_DO/hypoVolume,
    Temp = sum(TP_Weighted)/hypoVolume,
    Temp_sed = last(Temp_C),
    SA_m2 = mean(SA_m2))
vw_fcr
write.csv(vw_fcr, "../data/processed_data/vol_weighted_do_fcr.csv")


### BVR
vol_bvr <- read_csv("../data/processed_data/BVR Bathymetry.csv")[1:3]
colnames(vol_bvr) <- c("Depth_m","Volume_L","SA_m2")

depths <- vol_bvr$Depth_m

dt1_culled = df.final.new %>% filter(Reservoir == "BVR") %>%arrange(Date)
df.final2<-dt1_culled %>% group_by(Date) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[1]))) #Create a new dataframe
df.final2$Depth_m <- depths[1]
for (j in 2:length(depths)){ #loop through all depths and add the closest values to the final dataframe
  ctd_atThisDepth <- dt1_culled %>% group_by(Date) %>% slice(which.min(abs(as.numeric(Depth_m) - depths[j])))
  ctd_atThisDepth$Depth_m <- depths[j]
  df.final2 <- rbind(df.final2,ctd_atThisDepth)
}
df.final2_bvr = df.final2

thermo_bvr <- df.final2_bvr %>%
  filter(!is.na(Temp_C))%>%
  group_by(Date) %>%
  summarize(meta_bottom = meta.depths(Temp_C, Depth_m)[2])

vw_bvr <- df.final2_bvr %>%
  #filter(as.Date(Date)!=as.Date("2017-07-06")) %>%
  group_by(Date) %>%
  left_join(thermo_bvr, by = "Date") %>%
  mutate(Thermocline = meta_bottom) %>% 
  ungroup() %>%
  left_join(vol_bvr, by = "Depth_m")%>%
  mutate(DO_Weighted = DO_mgL*Volume_L,
         TP_Weighted = Temp_C*Volume_L) %>%
  filter(Depth_m >= Thermocline,) %>%
  group_by(Date) %>%
  summarize(
    Reservoir = "BVR",
    thermo_depth = unique(Thermocline),
    Vol_Weighted_DO = sum(DO_Weighted),
    hypoVolume = sum(Volume_L),
    DO_mgL = Vol_Weighted_DO/hypoVolume,
    Temp = sum(TP_Weighted)/hypoVolume,
    Temp_sed = last(Temp_C),
    SA_m2 = mean(SA_m2))
vw_bvr
write.csv(vw_bvr, "../data/processed_data/vol_weighted_do_bvr.csv")
```



Section 3: Interpolate and graph
This section interpolates volume-weighted dissolved oxygen concentrations to a daily timestep and creates a boxlplot comparing the two reservoirs across time. Inputs include volume-weighted dissolved oxygen data (created in the previous code chunk). One figure is output (DO_boxplot_2014_2021.jpeg).
```{r}
#Create an empty dataframe to store interpolation results
interp_do = data.frame(x = NA, y = NA, Reservoir = NA)
years = c(2013:2021)
#Loop through all years and interpolate volume-weighted DO data to a daily timestep throughout the stratified period
for(year in years){
  #Subset to this year
  do_fcr<- vw_fcr%>%
    mutate(Year = year(Date))%>%
    filter(Year == year,
           Reservoir == "FCR")
  do_bvr<- vw_bvr%>%
    mutate(Year = year(Date))%>%
    filter(Year == year,
           Reservoir == "BVR")
  #Interpolate
  do_fcr_interp <- data.frame(approx(do_fcr$Date,do_fcr$DO_mgL, xout = seq(min(do_fcr$Date), max(do_fcr$Date),1)))%>%
    mutate(Reservoir = "FCR")
  do_bvr_interp <- data.frame(approx(do_bvr$Date,do_bvr$DO_mgL, xout = seq(min(do_bvr$Date), max(do_bvr$Date),1)))%>%
    mutate(Reservoir = "BVR")
  #Join FCR and BVR
  interp_do = interp_do%>%
    full_join(do_fcr_interp)%>%
    full_join(do_bvr_interp)
}
#Filter out one empty row
interp_do = interp_do%>%
  filter(!is.na(Reservoir)) 


#Format interpolated DO data
interp_do_box = interp_do%>%
  mutate(DateTime = as.Date(x, origin = "1970-01-01"))%>% #Convert numeric dates to date format
  filter(month(DateTime) >5&month(DateTime)<10)%>%#June through the end of september were consistently stratified in both reservoirs
  rename(DO_mgL = y)%>%
  mutate(Year = year(DateTime))


#Plot results
jpeg("../figures/DO_boxplot_2014_2021.jpeg",width = 3.5, height = 3, units = "in", res = 300)
interp_do_box%>%
  filter(Year != 2013)%>% #Data are only available from FCR in 2013
  ggplot(aes(x = as.factor(Year), y = DO_mgL, color = Reservoir))+
  geom_vline(xintercept = as.factor(2019), cex = 12, color = "gray", alpha = 0.5)+ #Highlight focal years
  geom_vline(xintercept = as.factor(2021), cex = 12, color = "gray", alpha = 0.5)+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  xlab("")+
  scale_color_manual(values =  c("#4B4E6D","#80B192"))+
  ylab("Volume-weighted hypolimnetic \noxygen concentration (mg/L)")+
  theme(legend.position = "bottom",
        legend.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "pt"),
        axis.title.x = element_blank())
dev.off()
```



Section 4: Load DOC and iron data
This section loads data for DOC and iron in water column samples. These data will be used in the following code chunks
```{r}
#Load DOC data
chem <- read_csv('../data/clean_data/chemistry.csv') #2013-2020
doc_2021 <- read_csv("../data/clean_data/2021_TOC_collation.csv")%>% #2021 data to add
  mutate(DateTime = as.POSIXct(DateTime,format = "%m/%d/%y %H:%M"))%>%
  select(-DIC_mgL, -DC_mgL)
chem = chem%>% #Add 2021 data
  full_join(doc_2021)


#Load iron data from EDI
inUrl1  <- "https://pasta-s.lternet.edu/package/data/eml/edi/718/2/57912981e3e857c85924484806492446" 
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")
 metals <-read.csv(infile1,header=F 
          ,skip=1
            ,sep=","  
        , col.names=c(
                    "Reservoir",     
                    "Site",     
                    "DateTime",     
                    "Depth_m",     
                    "TFe_mgL",     
                    "TMn_mgL",     
                    "SFe_mgL",     
                    "SMn_mgL",     
                    "Flag_DateTime",     
                    "Flag_TFe",     
                    "Flag_TMn",     
                    "Flag_SFe",     
                    "Flag_SMn"    ), check.names=TRUE)
               
unlink(infile1)
```



Section 5: Graph Fe, DOC, and oxygen (Figure 5)
```{r}
#IRON
#Select the deepest Fe sample at each date/reservoir
metals_lowest = metals%>%
  mutate(DateTime = as.Date(DateTime, format = "%m/%d/%Y %H:%M"))%>% #Make sure date is correctly formatted
  filter(Site == 50)%>%
  group_by(Reservoir, DateTime)%>%
  filter(Depth_m == max(Depth_m),
         Depth_m > 8) #Only working with the lowest sample from each date at each reservoir. No samples should be <8m depth

# Join with DO data
metals_lowest_comb = metals_lowest%>%
  left_join(df.final.new%>%mutate(DateTime = as.Date(Date)))%>%
  filter(!is.na(TFe_mgL),!is.na(DO_mgL))

fe_lim = c(min(metals_lowest_comb$TFe_mgL, na.rm = T),max(metals_lowest_comb$TFe_mgL, na.rm = T))
do_lim = c(min(metals_lowest_comb$DO_mgL, na.rm = T),max(metals_lowest_comb$DO_mgL, na.rm = T))

#Plot Fe vs oxygen in both reservoirs
fe = metals_lowest_comb%>%
  filter(!is.na(DO_mgL))%>%
  ggplot(aes(y = TFe_mgL, x = DO_mgL))+
  geom_point(aes(color = Reservoir, shape = Reservoir))+
  theme_bw()+
  geom_text(aes(x = do_lim[2]/2, y = fe_lim[2]*9/10, label = "Spearman's R = -0.8\np<0.001"), size = 3)+
  scale_color_manual(values = c("#4B4E6D","#80B192"))+
  xlab("Dissolved oxygen (mg/L)")+
  ylim(0,fe_lim[2])+
  ylab("Total iron (mg/L)")

#DOC
#Select the deepest DOC sample at each date/reservoir
doc_lowest = chem%>%
  mutate(DateTime = as.Date(DateTime, format = "%m/%d/%Y %H:%M"))%>%
  filter(Reservoir %in% c("FCR","BVR"),
         Site == 50)%>%
  group_by(Reservoir, DateTime)%>%
  filter(Depth_m == max(Depth_m))

#Join with DO data
doc_lowest_comb = doc_lowest%>%
  left_join(df.final.new%>%mutate(DateTime = as.Date(Date)))%>%
  filter(!is.na(DOC_mgL),!is.na(DO_mgL))

#Calculate plot lims
doc_lim = c(min(doc_lowest_comb$DOC_mgL, na.rm = T),max(doc_lowest_comb$DOC_mgL, na.rm = T))

#Plot DOC vs oxygen in both reservoirs
doc = doc_lowest_comb%>%
  filter(!is.na(DO_mgL))%>%
  ggplot(aes(y = DOC_mgL, x = DO_mgL, color = Reservoir, shape = Reservoir))+
  geom_point()+
  theme_bw()+
  geom_text(aes(x = do_lim[2]/2, y = doc_lim[2]*9/10, label = "Spearman's R = -0.2\np=0.002"), color = "black", size = 3)+
  scale_color_manual(values = c("#4B4E6D","#80B192"))+
  xlab("Dissolved oxygen (mg/L)")+
  ylim(0,doc_lim[2])+
  ylab("DOC (mg/L)")

#Combine DOC and Fe datasets
lowest_comb = metals_lowest_comb%>%
  full_join(doc_lowest)

comb = lowest_comb%>%
  ggplot(aes(x = TFe_mgL,y = DOC_mgL, color = Reservoir))+
  geom_point()+
  theme_bw()+
  geom_text(aes(x = fe_lim[2]/2, y = doc_lim[2]*9/10, label = "Spearman's R = 0.5\np<0.001"), color = "black", size = 3)+
  scale_color_manual(values = c("#4B4E6D","#80B192"))+
  xlab("Total iron (mg/L)")+
  ylim(0,doc_lim[2])+
  ylab("DOC (mg/L)")

jpeg("../figures/Fe_and_DOC.jpeg",width = 7, height = 3, units = "in", res = 300)
ggarrange(fe,doc,comb, common.legend = T,nrow = 1, legend = "bottom", labels = "auto")
dev.off()

#STATS
cor.test(doc_lowest_comb$DOC_mgL,doc_lowest_comb$DO_mgL, method = "spearman")
cor.test(metals_lowest_comb$TFe_mgL,metals_lowest_comb$DO_mgL, method = "spearman")
cor.test(lowest_comb$DOC_mgL,lowest_comb$TFe_mgL, method = "spearman")
```
